define(["jquery","helper","mustache","admin/feedbackStream"],function(e,t,n,r){var i=function(){this.contentId=e(".js-content-single").attr("data-id"),this.readAll(this)};return i.prototype.readAll=function(i){t.getMustacheTemplate({template:"admin/content/meta/all",success:function(s){e.ajax({url:t.urlBase("admin/ajax/content/meta/"),type:"get",dataType:"json",data:{contentId:i.contentId},success:function(t){e(".js-content-meta-container").html(n.render(s,{metas:t})),i.eventsRefresh(i),i.getNewRow(i)},error:function(e){r.createMessage({message:"Network error.",type:"negative"})}})}})},i.prototype.eventsRefresh=function(n){var i,s;e(".js-content-meta-input-name, .js-content-meta-input-value").off("keyup.content-meta").on("keyup.content-meta",function(e){s=this,clearTimeout(i),i=setTimeout(function(){n.changeInput(n,s)},500)}),e(".js-content-meta-delete").on("click.content-meta",function(n){n.preventDefault();var i=e(this),s=i.closest(".js-content-meta"),o=s.attr("data-id");e.ajax({url:t.urlBase("admin/ajax/content/meta/delete/"),type:"get",dataType:"json",data:{id:o},complete:function(e){},success:function(e){e&&s.remove()},error:function(e){r.createMessage({message:"Network error.",type:"negative"})}})})},i.prototype.changeInput=function(n,i){var s=e(i),o=s.closest(".js-content-meta"),u=o.find(".js-content-meta-input-name"),a=o.find(".js-content-meta-input-value"),f=o.attr("data-id");u.off("change.content-meta"),a.off("change.content-meta"),e.ajax({url:t.urlBase("admin/ajax/content/meta/"+(f?f:"create")+"/"),type:"get",dataType:"json",data:{contentId:n.contentId,name:u.val(),value:a.val()},complete:function(){n.getNewRow(n)},success:function(e){o.attr("data-id",e.id),n.eventsRefresh(n)},error:function(e){r.createMessage({message:"Network error.",type:"negative"})}})},i.prototype.getNewRow=function(t){var n=e(".js-content-meta"),r=!0;for(var i=n.length-1;i>=0;i--)e(n[i]).attr("data-id")||(r=!1);r&&(n.last().clone().attr("data-id","").appendTo(".js-content-meta-container"),option=e(".js-content-meta").last(),option.find(".js-content-meta-input-name").val(""),option.find(".js-content-meta-input-value").val(""),t.eventsRefresh(t))},new i});